# 排查服务器外部访问问题

## ❌ 问题现象

在Mac上执行 `curl http://47.243.177.166:8081/api/list/原创视频` 没有响应。

---

## 🔍 排查步骤

### 步骤1：检查服务器是否在监听8081端口

**在服务器Workbench终端执行**：

```bash
# 检查8081端口是否在监听
netstat -tlnp | grep 8081

# 或者使用
ss -tlnp | grep 8081

# 或者使用
lsof -i :8081
```

**应该看到**：`python3` 进程在监听 `0.0.0.0:8081` 或 `:::8081`

**如果只看到 `127.0.0.1:8081`**，说明服务器只监听本地，需要修改配置。

---

### 步骤2：检查服务器进程

**在服务器Workbench终端执行**：

```bash
# 检查服务状态
systemctl status video-server

# 查看服务日志
journalctl -u video-server -n 50

# 检查进程
ps aux | grep video_server
```

---

### 步骤3：检查防火墙

**在服务器Workbench终端执行**：

```bash
# 检查防火墙状态
ufw status

# 如果防火墙开启，开放8081端口
ufw allow 8081/tcp

# 重新加载防火墙
ufw reload
```

---

### 步骤4：检查阿里云安全组

**在阿里云控制台操作**：

1. 登录阿里云控制台
2. 进入 **ECS实例** → 选择你的服务器（IP: 47.243.177.166）
3. 点击 **安全组** → **配置规则**
4. 检查 **入方向规则** 是否有 **8081端口**
5. 如果没有，点击 **添加安全组规则**：
   - **端口范围**：`8081/8081`
   - **授权对象**：`0.0.0.0/0`
   - **协议类型**：`TCP`
   - **描述**：`视频服务器`
   - 点击 **保存**

---

### 步骤5：在服务器上测试本地访问

**在服务器Workbench终端执行**：

```bash
# 测试本地访问
curl http://localhost:8081/api/list/原创视频

# 测试外部IP访问（从服务器内部）
curl http://47.243.177.166:8081/api/list/原创视频
```

**如果本地访问成功，但外部IP访问失败**，可能是安全组问题。

---

### 步骤6：检查video_server.py配置

**在服务器Workbench终端执行**：

```bash
cd /root/video_server

# 检查服务器是否监听所有接口
grep -i "host\|bind" video_server.py
```

**如果看到 `host='127.0.0.1'` 或 `host='localhost'`**，需要修改为 `host='0.0.0.0'`。

---

## 🔧 常见问题和解决方案

### 问题1：服务器只监听本地（127.0.0.1）

**解决方案**：修改 `video_server.py`，确保监听 `0.0.0.0`

```bash
cd /root/video_server

# 检查当前配置
grep -i "serve\|host" video_server.py

# 如果看到 host='127.0.0.1'，需要修改
# 查看文件内容
cat video_server.py | grep -A 5 "http.server\|HTTPServer"
```

---

### 问题2：防火墙阻止访问

**解决方案**：

```bash
# 开放8081端口
ufw allow 8081/tcp

# 检查状态
ufw status
```

---

### 问题3：安全组未配置

**解决方案**：在阿里云控制台添加安全组规则（见步骤4）

---

### 问题4：服务器进程未运行

**解决方案**：

```bash
# 重启服务
systemctl restart video-server

# 查看状态
systemctl status video-server

# 查看日志
journalctl -u video-server -n 50
```

---

## 📋 完整排查命令

**在服务器Workbench终端执行**：

```bash
# 1. 检查端口监听
netstat -tlnp | grep 8081

# 2. 检查服务状态
systemctl status video-server

# 3. 检查防火墙
ufw status
ufw allow 8081/tcp

# 4. 测试本地访问
curl http://localhost:8081/api/list/原创视频

# 5. 查看服务日志
journalctl -u video-server -n 50
```

---

## 🎯 现在可以执行

1. **在服务器Workbench终端执行上面的排查命令**
2. **在阿里云控制台检查安全组规则**
3. **告诉我结果，我会帮你进一步排查**

---

**先执行排查步骤，告诉我结果！** 🔍

