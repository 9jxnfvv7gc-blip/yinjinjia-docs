# 🔍 排查连接问题步骤

## ❌ 当前问题

应用仍然无法连接到服务器。

## 🔍 排查步骤

### 步骤1：确认服务器服务是否运行

**在服务器上执行**（保持SSH连接）：

```bash
# 检查8082端口是否在监听
ss -tlnp | grep 8082

# 如果没输出，说明服务停止了，需要重新启动
cd ~/link_server
python3 server.py &
```

**或者检查进程**：

```bash
ps aux | grep "python3 server.py" | grep -v grep
```

---

### 步骤2：确认防火墙是否已配置

**在阿里云控制台检查**：

1. 登录阿里云控制台
2. 进入 **ECS实例** → 找到北京服务器（39.107.137.136）
3. 点击 **防火墙** 标签
4. 检查是否有 **8082端口** 的规则
5. 如果没有，按照 `配置8082端口防火墙.md` 添加规则

---

### 步骤3：在服务器上测试本地访问

**在服务器上执行**：

```bash
# 测试本地访问
curl http://localhost:8082/api/categories

# 应该看到：
# [{"id":"video","name":"原创视频"}]
```

**如果本地访问成功，但外部访问失败**：
- 说明防火墙未配置或配置错误
- 需要检查防火墙规则

---

### 步骤4：检查server.py配置

**在服务器上检查**：

```bash
cd ~/link_server
cat server.py | grep "app.run"
```

**应该看到**：
```python
app.run(host="0.0.0.0", port=8082)
```

**如果是** `host="127.0.0.1"`：
- ❌ 只监听本地，需要改为 `0.0.0.0`

---

### 步骤5：检查links.json文件

**在服务器上执行**：

```bash
cd ~/link_server
cat links.json
```

**应该看到**：
```json
{
  "categories": [
    {"id": "video", "name": "原创视频"}
  ],
  "items": {
    "video": [
      {
        "id": "v1",
        "title": "B站示例视频",
        "url": "https://www.bilibili.com/video/..."
      }
    ]
  }
}
```

---

### 步骤6：在Mac上测试连接

**在Mac终端执行**：

```bash
# 测试连接
curl -v --connect-timeout 10 http://39.107.137.136:8082/api/categories

# 如果成功，应该看到JSON数据
# 如果超时，说明防火墙未配置
```

---

### 步骤7：查看应用日志

**在Mac上执行**：

```bash
# 查看应用日志
adb logcat -d | grep -i "http\|network\|connection\|error" | tail -50

# 或查看所有日志
adb logcat -d | tail -100
```

**查找关键信息**：
- 请求的URL是什么？
- 错误信息是什么？
- 连接超时还是被拒绝？

---

## 🔧 常见问题解决

### 问题1：服务器服务停止了

**解决**：
```bash
cd ~/link_server
nohup python3 server.py > server.log 2>&1 &
ss -tlnp | grep 8082  # 确认启动成功
```

---

### 问题2：防火墙未配置

**解决**：
- 按照 `配置8082端口防火墙.md` 在阿里云控制台添加规则
- 等待1-2分钟让规则生效
- 重新测试连接

---

### 问题3：server.py监听地址错误

**解决**：
```bash
cd ~/link_server
# 检查server.py最后几行
tail -5 server.py

# 确保是：
# app.run(host="0.0.0.0", port=8082)
```

---

### 问题4：links.json文件不存在或格式错误

**解决**：
```bash
cd ~/link_server
# 检查文件是否存在
ls -la links.json

# 如果不存在，创建文件
cat > links.json << 'EOF'
{
  "categories": [
    {"id": "video", "name": "原创视频"}
  ],
  "items": {
    "video": [
      {
        "id": "v1",
        "title": "B站示例视频",
        "url": "https://www.bilibili.com/video/BV1kiJQzEEfc/?vd_source=ccda4d6e7db47e00901da8487331cae1"
      },
      {
        "id": "v2",
        "title": "好看视频示例",
        "url": "https://haokan.baidu.com/v?vid=12017376708808857166&"
      },
      {
        "id": "v3",
        "title": "阅读APP示例",
        "url": "https://app.readoor.cn/app/cm/pl/1565837139/325724-6405406718c72f?l_id=783836&s=1&j=1"
      }
    ]
  }
}
EOF
```

---

## ✅ 完整检查清单

- [ ] 服务器8082端口是否在监听？（`ss -tlnp | grep 8082`）
- [ ] Flask服务是否正在运行？（`ps aux | grep server.py`）
- [ ] 防火墙是否开放8082端口？（阿里云控制台检查）
- [ ] server.py是否监听0.0.0.0？（`cat server.py | grep app.run`）
- [ ] links.json文件是否存在且格式正确？（`cat links.json`）
- [ ] 服务器本地访问是否成功？（`curl http://localhost:8082/api/categories`）
- [ ] Mac能否访问服务器？（`curl http://39.107.137.136:8082/api/categories`）
- [ ] 应用日志显示什么错误？（`adb logcat -d | grep -i error`）

---

## 📱 如果所有检查都正常

如果所有检查都正常，但仍然无法连接：

1. **重启服务器上的Flask服务**：
   ```bash
   pkill -f "python3 server.py"
   cd ~/link_server
   nohup python3 server.py > server.log 2>&1 &
   ```

2. **等待防火墙规则生效**（可能需要1-2分钟）

3. **重新测试连接**

4. **查看应用详细日志**：
   ```bash
   adb logcat -c  # 清除旧日志
   # 在手机上打开应用
   adb logcat | grep -i "http\|network\|connection"
   ```

