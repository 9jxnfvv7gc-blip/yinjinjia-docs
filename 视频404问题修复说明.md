# 视频404问题修复说明

## 🔍 问题分析

从日志可以看到：
1. ✅ 应用成功加载了105个视频
2. ✅ 用户点击视频：`儋州粽子.mp4`
3. ✅ URL编码正确：`http://47.243.177.166:8081/video/%E5%8E%9F%E5%88%9B%E8%A7%86%E9%A2%91/%E5%84%8B%E5%B7%9E%E7%B2%BD%E5%AD%90.mp4`
4. ❌ 服务器返回404错误

**测试结果**：
- 即使使用未编码的URL，服务器也返回404
- 这说明问题不在URL编码，而是服务器路径处理有问题

---

## ✅ 已修复

### 1. 客户端代码（已完成）
- ✅ 增强了URL处理逻辑
- ✅ 添加了详细的调试日志
- ✅ 改进了错误提示

### 2. 服务器代码（需要部署）
**文件**: `video_server.py`

**修复内容**:
- 改进了路径提取逻辑（使用切片而不是replace）
- 添加了详细的调试信息
- 确保URL解码正确

**修复前**:
```python
media_path = self.path.replace('/video/', '').replace('/music/', '')
full_path = os.path.join(VIDEO_ROOT, unquote(media_path))
```

**修复后**:
```python
# 提取媒体路径（去掉 /video/ 或 /music/ 前缀）
if self.path.startswith('/video/'):
    media_path = self.path[7:]  # 去掉 '/video/'
else:
    media_path = self.path[7:]  # 去掉 '/music/'

# 解码URL编码的路径
decoded_path = unquote(media_path)
full_path = os.path.join(VIDEO_ROOT, decoded_path)

# 调试信息
sys.stderr.write(f"视频请求路径: {self.path}\n")
sys.stderr.write(f"提取的media_path: {media_path}\n")
sys.stderr.write(f"解码后的路径: {decoded_path}\n")
sys.stderr.write(f"完整文件路径: {full_path}\n")
sys.stderr.write(f"文件是否存在: {os.path.exists(full_path)}\n")
```

---

## 🚀 部署步骤

### 步骤1：上传修复后的服务器代码

**方法1：使用scp（推荐）**
```bash
cd "/Volumes/Expansion/FlutterProjects/桌面影音播放器_安装包_20251121_165905"
scp video_server.py root@47.243.177.166:/root/video_server/
```

**方法2：使用Workbench文件管理器**
1. 打开Workbench文件管理器
2. 导航到 `/root/video_server/`
3. 上传本地的 `video_server.py` 文件（覆盖现有文件）

### 步骤2：重启服务器

在Workbench终端执行：
```bash
# 停止服务器
pkill -f video_server.py
systemctl stop video-server

# 重新启动服务器
cd /root/video_server
python3 video_server.py > /tmp/video_server.log 2>&1 &
sleep 2

# 检查服务器是否启动
ps aux | grep video_server.py | grep -v grep
```

### 步骤3：测试修复

```bash
# 测试视频URL（使用编码后的URL）
curl -I "http://47.243.177.166:8081/video/%E5%8E%9F%E5%88%9B%E8%A7%86%E9%A2%91/%E5%84%8B%E5%B7%9E%E7%B2%BD%E5%AD%90.mp4"

# 应该返回 HTTP 200 而不是 404
```

### 步骤4：查看服务器日志

```bash
# 查看服务器日志（查看调试信息）
tail -f /tmp/video_server.log

# 或者查看systemd日志
journalctl -u video-server -f
```

---

## 🔍 调试信息

修复后，服务器日志会显示：
```
视频请求路径: /video/原创视频/儋州粽子.mp4
提取的media_path: 原创视频/儋州粽子.mp4
解码后的路径: 原创视频/儋州粽子.mp4
完整文件路径: /root/videos/原创视频/儋州粽子.mp4
文件是否存在: True/False
```

**如果文件不存在**：
- 检查服务器上的文件路径是否正确
- 确认文件是否在 `/root/videos/原创视频/` 目录下
- 检查文件名是否正确（包括大小写）

**如果路径处理有问题**：
- 查看日志中的"提取的media_path"和"解码后的路径"
- 确认路径是否正确

---

## 📝 注意事项

1. **备份服务器代码**：上传前建议先备份
   ```bash
   ssh root@47.243.177.166 "cp /root/video_server/video_server.py /root/video_server/video_server.py.bak"
   ```

2. **检查文件权限**：确保服务器有读取文件的权限
   ```bash
   ls -la /root/videos/原创视频/
   ```

3. **测试多个视频**：修复后测试多个不同的视频文件，确保都能正常播放

---

## 🎯 预期结果

修复后：
- ✅ 视频URL应该返回 HTTP 200
- ✅ 视频应该能够正常播放
- ✅ 服务器日志应该显示正确的文件路径
- ✅ 不再出现404错误

---

**修复日期**: 2025-11-25
**需要操作**: 上传服务器代码并重启服务器










