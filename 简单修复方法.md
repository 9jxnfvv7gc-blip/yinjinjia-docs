# ç®€å•ä¿®å¤æ–¹æ³•

## ğŸš€ åœ¨Workbenchç»ˆç«¯æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
# åœæ­¢æœåŠ¡å™¨
pkill -f video_server.py
systemctl stop video-server

# å¤‡ä»½æ–‡ä»¶
cp /root/video_server/video_server.py /root/video_server/video_server.py.bak10

# ä¿®æ”¹titleè¡Œï¼ˆç¬¬680è¡Œå·¦å³ï¼‰
sed -i 's/title = os\.path\.splitext(f)\[0\]/# ä½¿ç”¨å®Œæ•´æ–‡ä»¶åä½œä¸ºtitle\ntitle = f/' /root/video_server/video_server.py

# ä¿®æ”¹urlæ„å»ºï¼ˆéœ€è¦æ‰¾åˆ°urlè¡Œå¹¶æ›¿æ¢ï¼‰
# å…ˆæ‰¾åˆ°urlè¡Œçš„ä½ç½®
python3 << 'EOF'
import re

file_path = '/root/video_server/video_server.py'
with open(file_path, 'r', encoding='utf-8') as f:
    content = f.read()

# æŸ¥æ‰¾å¹¶æ›¿æ¢urlæ„å»º
# æ‰¾åˆ°åŒ…å« url_prefix å’Œ relative_path çš„urlè¡Œ
pattern = r"('url': f'\{url_prefix\}\{relative_path\}')"
replacement = """# æ„å»ºå®Œæ•´çš„URLï¼ˆä½¿ç”¨æœåŠ¡å™¨IPï¼‰
                            # è·å–æœåŠ¡å™¨IPï¼ˆä»è¯·æ±‚å¤´æˆ–ä½¿ç”¨é»˜è®¤å€¼ï¼‰
                            server_host = self.headers.get('Host', '47.243.177.166:8081')
                            if ':' not in server_host:
                                server_host = f"{server_host}:8081"
                            full_url = f"http://{server_host}/{relative_path.replace(os.sep, '/')}"
                            'url': full_url"""

new_content = re.sub(
    r"'url': f'\{url_prefix\}\{relative_path\}'",
    replacement,
    content
)

# å¦‚æœæ²¡æ‰¾åˆ°ï¼Œå°è¯•å…¶ä»–æ¨¡å¼
if new_content == content:
    # å°è¯•æŸ¥æ‰¾å­—å…¸ä¸­çš„urlè¡Œ
    lines = content.split('\n')
    new_lines = []
    i = 0
    while i < len(lines):
        line = lines[i]
        if "'url': f'{url_prefix}{relative_path}'" in line or '"url": f\'{url_prefix}{relative_path}\'' in line:
            indent = len(line) - len(line.lstrip())
            new_lines.append(' ' * indent + "# æ„å»ºå®Œæ•´çš„URLï¼ˆä½¿ç”¨æœåŠ¡å™¨IPï¼‰")
            new_lines.append(' ' * indent + "# è·å–æœåŠ¡å™¨IPï¼ˆä»è¯·æ±‚å¤´æˆ–ä½¿ç”¨é»˜è®¤å€¼ï¼‰")
            new_lines.append(' ' * indent + "server_host = self.headers.get('Host', '47.243.177.166:8081')")
            new_lines.append(' ' * indent + "if ':' not in server_host:")
            new_lines.append(' ' * indent + "    server_host = f\"{server_host}:8081\"")
            new_lines.append(' ' * indent + "full_url = f\"http://{server_host}/{relative_path.replace(os.sep, '/')}\"")
            new_lines.append(' ' * indent + "'url': full_url,")
        else:
            new_lines.append(line)
        i += 1
    new_content = '\n'.join(new_lines)

# ä¿®æ”¹idè¡Œ
new_content = re.sub(r"'id': file_path,", "'id': f,  # ä½¿ç”¨æ–‡ä»¶åä½œä¸ºid", new_content)

# å†™å›æ–‡ä»¶
with open(file_path, 'w', encoding='utf-8') as f:
    f.write(new_content)

# æ£€æŸ¥è¯­æ³•
import subprocess
result = subprocess.run(['python3', '-m', 'py_compile', file_path], capture_output=True)
if result.returncode == 0:
    print('âœ… ä»£ç ä¿®æ”¹æˆåŠŸï¼Œè¯­æ³•æ£€æŸ¥é€šè¿‡')
else:
    print('âŒ è¯­æ³•é”™è¯¯:')
    print(result.stderr.decode())
EOF

# é‡æ–°å¯åŠ¨æœåŠ¡å™¨
cd /root/video_server
python3 video_server.py > /tmp/video_server.log 2>&1 &
sleep 2

# æµ‹è¯•API
curl "http://localhost:8081/api/list/$(python3 -c "from urllib.parse import quote; print(quote('åŸåˆ›è§†é¢‘'))")"
```

---

## ğŸ“‹ æ‰§è¡Œå

æŠŠè¾“å‡ºç»“æœå‘ç»™æˆ‘ï¼Œç‰¹åˆ«æ˜¯ï¼š
1. **ä¿®å¤è„šæœ¬çš„è¾“å‡º**ï¼ˆæ˜¯å¦æˆåŠŸï¼‰
2. **APIè¿”å›çš„JSONç»“æœ**

---

**ç›´æ¥å¤åˆ¶ä¸Šé¢çš„å‘½ä»¤åˆ°Workbenchç»ˆç«¯æ‰§è¡Œï¼** ğŸš€

