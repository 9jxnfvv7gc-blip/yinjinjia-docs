# 解决外部访问失败问题

## ❌ 问题现象

在Mac上执行 `curl http://47.243.177.166:8081/api/list/原创视频` 失败：
```
curl: (28) Failed to connect to 47.243.177.166 port 8081 after 75023 ms: Couldn't connect to server
```

---

## 🔍 可能的原因

1. **阿里云安全组未配置8081端口**（最常见）
2. **服务器防火墙阻止了外部访问**
3. **服务器只监听本地接口**

---

## 🚀 解决步骤

### 步骤1：检查阿里云安全组（最重要）

**在阿里云控制台操作**：

1. 登录阿里云控制台
2. 进入 **ECS实例** → 选择你的服务器（IP: 47.243.177.166）
3. 点击 **安全组** → **配置规则**
4. 检查 **入方向规则** 是否有 **8081端口**
5. 如果没有，点击 **添加安全组规则**：
   - **端口范围**：`8081/8081`
   - **授权对象**：`0.0.0.0/0`
   - **协议类型**：`TCP`
   - **描述**：`视频服务器`
   - 点击 **保存**

**重要**：配置完安全组后，等待1-2分钟让规则生效。

---

### 步骤2：检查服务器防火墙

**在Workbench终端执行**：

```bash
# 检查防火墙状态
ufw status

# 如果防火墙开启，开放8081端口
ufw allow 8081/tcp

# 重新加载防火墙
ufw reload

# 验证端口已开放
ufw status | grep 8081
```

---

### 步骤3：验证服务器监听状态

**在Workbench终端执行**：

```bash
# 检查8081端口是否监听所有接口
netstat -tlnp | grep 8081
```

**应该看到**：`0.0.0.0:8081` 或 `:::8081`（监听所有接口）

**如果只看到 `127.0.0.1:8081`**，说明只监听本地，需要检查服务器配置。

---

### 步骤4：测试本地访问

**在Workbench终端执行**：

```bash
# 测试本地访问
curl http://localhost:8081/api/list/原创视频

# 测试外部IP访问（从服务器内部）
curl http://47.243.177.166:8081/api/list/原创视频
```

**如果本地访问成功，但外部IP访问失败**，说明是安全组问题。

---

### 步骤5：重新测试外部访问

**配置完安全组和防火墙后，在你的Mac终端执行**：

```bash
# 测试外部访问（不要包含 # 符号）
curl http://47.243.177.166:8081/api/list/原创视频
```

**应该返回**：`[]`（空数组）

---

## 📋 完整排查流程

### 1. 在阿里云控制台配置安全组
- 开放8081端口
- 等待1-2分钟

### 2. 在Workbench终端检查防火墙
```bash
ufw status
ufw allow 8081/tcp
ufw reload
```

### 3. 在Workbench终端验证监听
```bash
netstat -tlnp | grep 8081
```

### 4. 在Mac终端测试外部访问
```bash
curl http://47.243.177.166:8081/api/list/原创视频
```

---

## 💡 常见问题

### 问题1：安全组配置了但还是无法访问

**解决方案**：
- 等待1-2分钟让规则生效
- 检查安全组规则是否正确（端口、协议、授权对象）
- 检查是否有其他安全组规则阻止了访问

### 问题2：防火墙阻止了访问

**解决方案**：
```bash
ufw allow 8081/tcp
ufw reload
```

### 问题3：服务器只监听本地

**解决方案**：
- 检查 `video_server.py` 配置
- 确认使用 `socketserver.TCPServer(("", PORT), VideoHandler)`（已确认正确）

---

## 🎯 现在可以执行

1. **配置安全组**（在阿里云控制台，开放8081端口）
2. **检查防火墙**（在Workbench终端：`ufw allow 8081/tcp`）
3. **等待1-2分钟**
4. **测试外部访问**（在Mac终端：`curl http://47.243.177.166:8081/api/list/原创视频`）

---

## ⚠️ 重要提示

- **命令中不要包含 `#` 符号**（这是注释符号）
- **配置完安全组后等待1-2分钟**让规则生效
- **确保安全组规则正确**（端口、协议、授权对象）

---

**先配置安全组，然后检查防火墙！** 🔧

