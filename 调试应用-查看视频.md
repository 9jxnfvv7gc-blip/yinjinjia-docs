# 🔧 调试应用 - 查看视频

## 📋 当前状态

- **应用配置**: 已指向北京服务器 `39.107.137.136:8081`
- **服务器状态**: ❌ 无法连接（8081端口未响应）

## 🚀 解决步骤

### 方案1：启动北京服务器（推荐）

#### 步骤1：上传 video_server.py 到服务器

在本地 Mac 执行：

```bash
cd "/Volumes/Expansion/FlutterProjects/桌面影音播放器_安装包_20251121_165905"
bash 上传video_server到北京服务器.sh
```

或手动上传：

```bash
scp video_server.py root@39.107.137.136:/root/app/
```

#### 步骤2：连接到服务器并启动

```bash
# 连接到服务器
ssh root@39.107.137.136

# 在服务器上执行
export VIDEO_ROOT="/root/videos"
cd /root/app
nohup python3 video_server.py > /root/server.log 2>&1 &

# 检查是否启动成功
ps aux | grep video_server.py
tail -f /root/server.log
```

#### 步骤3：开放防火墙端口

在服务器上执行：

```bash
# Ubuntu/Debian
sudo ufw allow 8081/tcp
sudo ufw reload

# CentOS/RHEL
sudo firewall-cmd --permanent --add-port=8081/tcp
sudo firewall-cmd --reload
```

#### 步骤4：检查阿里云安全组

1. 登录阿里云控制台
2. 进入 ECS → 安全组
3. 添加入站规则：端口 8081，协议 TCP，授权对象 0.0.0.0/0

#### 步骤5：测试服务器

```bash
# 在服务器上测试
curl http://localhost:8081/api/categories
curl http://localhost:8081/api/list/原创视频

# 在本地 Mac 测试
curl http://39.107.137.136:8081/api/categories
```

### 方案2：使用本地服务器（临时测试）

如果北京服务器暂时无法启动，可以使用本地服务器测试：

#### 步骤1：修改配置

编辑 `lib/config.dart`，临时切换到本地服务器：

```dart
static String get apiBaseUrl {
  // 临时使用本地服务器
  return 'http://192.168.10.103:8081';  // 你的 Mac 本地 IP
}
```

#### 步骤2：启动本地服务器

```bash
cd "/Volumes/Expansion/FlutterProjects/桌面影音播放器_安装包_20251121_165905"
export VIDEO_ROOT="/Volumes/Expansion"  # 或你的视频目录
python3 video_server.py
```

#### 步骤3：确保 iOS 设备在同一 WiFi

- Mac 和 iPhone 必须在同一 WiFi 网络
- Mac 的 IP 地址是 `192.168.10.103`（根据实际情况修改）

### 方案3：使用香港服务器（临时）

如果北京服务器无法启动，可以临时使用香港服务器：

编辑 `lib/config.dart`：

```dart
static String get apiBaseUrl {
  // 临时使用香港服务器
  return productionApiUrl;  // http://47.243.177.166:8081
}
```

## 🧪 测试应用

### 步骤1：重新运行应用

```bash
cd "/Volumes/Expansion/FlutterProjects/桌面影音播放器_安装包_20251121_165905"
flutter clean
flutter pub get
flutter run -d Dianhua
```

### 步骤2：检查日志

在应用运行时，查看控制台输出：
- 应该看到 "正在加载视频..."
- 应该看到 "请求视频列表: http://..."
- 如果连接成功，应该看到视频列表

### 步骤3：检查应用界面

- 应用应该显示"精选视频"标题
- 应该显示视频卡片
- 点击视频应该能播放

## 🔍 调试技巧

### 查看网络请求

在 `simple_home_page_safe.dart` 中，已经有详细的日志输出：
- `flutter: 请求视频列表: ...`
- `flutter: 请求异常: ...`
- `flutter: 视频加载完成，数量: ...`

### 检查服务器响应

```bash
# 测试分类列表
curl http://39.107.137.136:8081/api/categories

# 测试视频列表
curl http://39.107.137.136:8081/api/list/原创视频

# 测试音乐列表
curl http://39.107.137.136:8081/api/list/原创歌曲
```

### 常见问题

1. **"网络异常，无法连接到服务器"**
   - 检查服务器是否运行
   - 检查防火墙是否开放端口
   - 检查安全组配置

2. **"返回 0 个视频"**
   - 检查 `VIDEO_ROOT` 环境变量
   - 检查视频文件是否存在
   - 检查目录结构是否正确

3. **"No route to host"**
   - 检查网络连接
   - 检查服务器 IP 地址是否正确
   - 检查防火墙设置

## ✅ 验证清单

- [ ] 服务器可以 ping 通
- [ ] video_server.py 正在运行
- [ ] 8081 端口正在监听
- [ ] 防火墙已开放 8081 端口
- [ ] 阿里云安全组已配置
- [ ] 本地可以访问 API
- [ ] 应用可以连接服务器
- [ ] 应用显示视频列表
- [ ] 视频可以播放


