# ✅ 国内版连接问题解决记录

## 📅 日期：2025年12月2日

## ❌ 问题描述

国内版APK（domestic flavor）无法连接到服务器，显示"网络异常，无法连接到服务器"。

## 🔍 问题排查过程

### 1. 服务器配置问题
- **问题**：Flask链接服务器（8082端口）未启动
- **解决**：在服务器上启动服务
  ```bash
  cd ~/link_server
  nohup python3 server.py > server.log 2>&1 &
  ```

### 2. 防火墙配置问题
- **问题1**：阿里云控制台防火墙未开放8082端口
- **解决1**：在阿里云控制台添加防火墙规则（TCP 8082端口）

- **问题2**：服务器系统防火墙（ufw）未开放8082端口
- **解决2**：执行 `sudo ufw allow 8082/tcp`

### 3. Android应用权限问题
- **问题**：`AndroidManifest.xml` 缺少网络权限
  - 缺少 `INTERNET` 权限
  - 缺少 `ACCESS_NETWORK_STATE` 权限
  - 缺少 `usesCleartextTraffic="true"` 设置（允许HTTP连接）
- **解决**：在 `AndroidManifest.xml` 中添加：
  ```xml
  <uses-permission android:name="android.permission.INTERNET"/>
  <uses-permission android:name="android.permission.ACCESS_NETWORK_STATE"/>
  
  <application
      ...
      android:usesCleartextTraffic="true">
  ```

## ✅ 最终解决方案

### 服务器端配置
1. ✅ Flask服务在后台运行（8082端口）
2. ✅ 阿里云防火墙开放8082端口
3. ✅ 系统防火墙（ufw）开放8082端口

### 应用端配置
1. ✅ 代码使用 `beijingLinkApiUrl`（8082端口）
2. ✅ `AndroidManifest.xml` 包含所有必需的网络权限
3. ✅ 允许HTTP连接（`usesCleartextTraffic="true"`）

## 📱 测试结果

- ✅ Mac可以访问：`http://39.107.137.136:8082/api/categories`
- ✅ 服务器本地可以访问：`http://localhost:8082/api/categories`
- ✅ 手机应用可以正常连接服务器并显示链接列表

## 📦 APK版本

- **修复版本**：`app-domestic-release-fixed.apk`
- **位置**：`backups/apk_20251201/app-domestic-release-fixed.apk`
- **包含修复**：
  - 网络权限配置
  - HTTP连接支持
  - 8082端口链接服务器配置

## 🔧 相关文件

- `lib/config.dart` - 包含 `beijingLinkApiUrl` 配置
- `lib/simple_home_page_links.dart` - 使用8082端口链接服务器
- `android/app/src/main/AndroidManifest.xml` - 包含网络权限配置

## 📝 注意事项

1. **服务器服务**：需要确保Flask服务持续运行
   - 可以使用 `systemd` 配置自动启动
   - 或使用 `nohup` 在后台运行

2. **防火墙规则**：
   - 阿里云控制台防火墙规则
   - 服务器系统防火墙（ufw）规则
   - 两者都需要配置

3. **网络权限**：
   - `INTERNET` 权限是必需的
   - `usesCleartextTraffic="true"` 允许HTTP连接（非HTTPS）

## 🎉 问题已解决

国内版应用现在可以正常连接服务器，显示链接列表，并可以跳转到外部浏览器查看视频和音乐内容。

