# 配置北京服务器

## 📋 服务器信息

- **IP地址**：39.107.137.136
- **位置**：北京
- **用途**：CDN加速节点/备用服务器

---

## 🎯 配置方案

### 方案1：作为CDN加速节点（推荐）

**优势**：
- 北京服务器距离大陆用户更近，访问速度更快
- 可以分担香港服务器的负载
- 提供更好的用户体验

**配置**：
- 部署相同的`video_server.py`
- 同步视频和音乐内容
- 在Flutter应用中实现智能选择服务器（根据网络延迟选择）

---

### 方案2：作为备用服务器

**优势**：
- 如果香港服务器出现问题，可以快速切换
- 提供高可用性

**配置**：
- 部署相同的`video_server.py`
- 定期同步内容
- 配置自动切换

---

## 🚀 配置步骤

### 步骤1：连接服务器

使用Workbench或SSH连接：
- **IP**：39.107.137.136
- **端口**：22（SSH）或使用Workbench

---

### 步骤2：部署video_server.py

#### 方法1：使用scp上传（推荐）

在你的Mac终端执行：

```bash
scp "/Volumes/Expansion/FlutterProjects/桌面影音播放器_安装包_20251121_165905/video_server.py" root@39.107.137.136:/root/video_server/
```

#### 方法2：使用Workbench文件管理器

1. 打开Workbench
2. 连接到服务器
3. 上传`video_server.py`到`/root/video_server/`

---

### 步骤3：配置服务器

在服务器终端执行：

```bash
# 1. 创建目录
mkdir -p /root/video_server
mkdir -p /root/videos/原创视频
mkdir -p /root/videos/原创歌曲

# 2. 如果文件已上传，修改VIDEO_ROOT
sed -i '20s|VIDEO_ROOT = "/Volumes/Expansion"|VIDEO_ROOT = "/root/videos"|g' /root/video_server/video_server.py

# 3. 确认配置
grep -n "VIDEO_ROOT" /root/video_server/video_server.py | head -1
```

---

### 步骤4：配置自动启动

```bash
# 1. 创建systemd服务文件
cat > /etc/systemd/system/video-server-beijing.service << 'EOF'
[Unit]
Description=Video Server (Beijing)
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/root/video_server
ExecStart=/usr/bin/python3 /root/video_server/video_server.py
Restart=always
RestartSec=10
StandardOutput=append:/var/log/video-server-beijing.log
StandardError=append:/var/log/video-server-beijing-error.log

[Install]
WantedBy=multi-user.target
EOF

# 2. 重新加载systemd配置
systemctl daemon-reload

# 3. 启用服务（开机自启）
systemctl enable video-server-beijing

# 4. 启动服务
systemctl start video-server-beijing

# 5. 检查服务状态
systemctl status video-server-beijing
```

---

### 步骤5：配置防火墙和安全组

#### 在服务器上配置防火墙

```bash
# 开放8081端口
ufw allow 8081/tcp
ufw reload
```

#### 在云服务商控制台配置安全组

- **阿里云**：在ECS控制台 -> 安全组 -> 添加规则（端口8081）
- **腾讯云**：在CVM控制台 -> 安全组 -> 添加规则（端口8081）

---

### 步骤6：同步内容（从香港服务器）

#### 方法1：使用rsync（如果SSH可用）

```bash
# 从香港服务器同步到北京服务器
rsync -avz -e ssh root@47.243.177.166:/root/videos/ /root/videos/
```

#### 方法2：使用Workbench文件管理器

1. 从香港服务器下载内容
2. 上传到北京服务器

---

### 步骤7：测试服务器

```bash
# 测试API
curl "http://39.107.137.136:8081/api/list/$(python3 -c "from urllib.parse import quote; print(quote('原创视频'))")"

# 查看日志
tail -20 /var/log/video-server-beijing.log
```

---

## 🔧 在Flutter应用中配置多服务器

### 修改config.dart支持多服务器

可以添加智能选择服务器的逻辑：
- 根据网络延迟选择最快的服务器
- 或者根据用户位置选择最近的服务器

---

## 📋 执行顺序

1. **连接北京服务器**（Workbench或SSH）
2. **上传video_server.py**
3. **配置VIDEO_ROOT**
4. **配置自动启动**
5. **配置防火墙和安全组**
6. **同步内容**
7. **测试服务器**

---

**先连接服务器，然后告诉我连接方式（Workbench或SSH），我会指导你完成配置！** 🚀

